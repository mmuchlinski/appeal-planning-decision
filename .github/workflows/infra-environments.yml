name: Environment Infrastructure

# Run after building
on:
  push:
    branches:
      - main
      - master
      # @todo remove
      - feature/*
    paths:
      - infrastructure/environments/**/*
      - infrastructure/modules/**/*
      - environments/**/*

defaults:
  run:
    working-directory: infrastructure/environments

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  TF_CLI_ARGS: -no-color
  TF_INPUT: false
  TF_IN_AUTOMATION: 1

jobs:
  provision:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment:
          - dev
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.13.4
          terraform_wrapper: false

      - name: "Terraform environment: ${{ matrix.environment }}"
        run: echo ${{ matrix.environment }}

      - name: Terraform Init
        run: |
          terraform init
          terraform workspace new "${{ matrix.environment }}" || true
          terraform workspace select "${{ matrix.environment }}"

      - name: Get Terraform variables
        id: vars
        run: |
          VARS_FILE="../../${{ matrix.environment }}.tfvars"

          # Don't fail if file doesn't exist
          touch ${VARS_FILE}

          echo "::set-output name=tfvars::$VARS_FILE"

      - run: terraform plan -var-file="${{ steps.vars.outputs.tfvars }}" -out tfplan

      - name: Unlock resources
        run: bash ../scripts/lockResourceGroups.sh
          unlock
          "$(terraform workspace show)"
          "$(terraform output app-name)"

      - run: terraform apply tfplan

      - name: Lock resources
        if: ${{ always() }}
        run: bash ../scripts/lockResourceGroups.sh
          lock
          "$(terraform workspace show)"
          "$(terraform output app-name)"
